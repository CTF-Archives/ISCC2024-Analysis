<!DOCTYPE html>
<html class="h-100" lang="zh-CN">

<head>
    <title>ISCC选手分析器</title>
    <meta charset="utf-8">
    <link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css"
        integrity="sha384-wEmeIV1mKuiNpC+IOBjI7aAzPcEZeedi5yW5f2yOq55WWLwNGmvvx4Um1vskeMj0" rel="stylesheet">
</head>

<body class="h-100 m-0">
    <div class="container-fluid h-100 p-0 d-flex flex-column">
        <div class="row m-0">
            <nav class="navbar navbar-expand-sm navbar-light bg-light">
                <a id="logo" class="btn btn-outline-primary navbar-brand" href="#">ISCC2024 选手分析器</a>
                <span class="navbar-text">
                    <a>数据自动采集于：</a>
                    <br>
                    <a><span id="time"></span></a>
                </span>
                <div style="width: 20px;"></div>
                <div class="collapse navbar-collapse d-flex">
                    <div class="col-2 form-floating">
                        <input class="form-control" id="name" placeholder="用户名">
                        <label for="name">用户名</label>
                    </div>
                    <div class="col-2 form-floating">
                        <input class="form-control" id="minSimilarity" placeholder="最小相似度" type="number" min="0"
                            max="100" value="30">
                        <label for="minSimilarity">最小相似度</label>
                    </div>
                    <div class="col-2 form-floating">
                        <input class="form-control" id="minScore" placeholder="最小成绩" type="number" min="0" value="2000">
                        <label for="minScore">最小成绩</label>
                    </div>
                    <div class="col-2">
                        <button class="col-2 form-control btn btn-outline-primary ms-1" id="analysis"
                            type="button">寻找相似度</button>
                    </div>
                    <div class="d-flex flex-column">

                    </div>

                    <div class="col-2">
                        <button class="col-2 form-control btn btn-outline-primary ms-1" id="search_single"
                            type="button">画出个人关系网</button>
                    </div>
                    <div class="col-2">
                        <button class="col-2 form-control btn btn-outline-primary ms-1" id="search_all"
                            type="button">递归画出全体关系网</button>
                    </div>
                </div>
            </nav>
        </div>
        <div class="row m-0 flex-grow-1 d-flex flex-column">
            <div class="p-0 flex-grow-1" id="cvs"></div>
        </div>
    </div>
    <div class="modal fade" id="analysisResult" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">相似度匹配结果</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-hover text-center">
                        <thead>
                            <tr>
                                <th scope="col">id</th>
                                <th scope="col">用户名</th>
                                <th scope="col">分数</th>
                                <th scope="col">相似度</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="about" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">关于</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="container">
                        <div class="row">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">ISCC2024 选手分析器</h5>
                                    <h6 class="card-subtitle mb-2 text-muted"><a target="_blank"
                                            href="https://github.com/CTF-Archives/ISCC2024-Analysis">CTF-Archives/ISCC2024-Analysis</a>
                                    </h6>
                                    <p class="card-text">一个通过python脚本采集选手提交flag情况并根据特定算法生成相似度以供web分析的项目。</p>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <ol>
                                <br>
                                <li>本项目未对任何服务器进行渗透、入侵</li>
                                <li>本项目算法核心为正态分布的概率密度函数</li>
                                <li>本项目计算分数并不包括理论题</li>
                                <li>本项目所有结果仅供参考</li>
                                <li>如有问题请提交 issue</li>
                                <a
                                    href="https://github.com/CTF-Archives/ISCC2024-Analysis/issues">CTF-Archives/ISCC2024-Analysis/issues</a>
                            </ol>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script crossorigin="anonymous" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p"
        src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script crossorigin="anonymous" integrity="sha384-lpyLfhYuitXl2zRZ5Bn2fqnhNAKOAaM/0Kr9laMspuaMiZfGmfwRNFh8HlMy49eQ"
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js" type="text/javascript"></script>
    <script type="text/javascript">
        function normalpdf(x, μ = 0, u = 1) {
            if (u === 0) {
                return x === μ ? Infinity : 0;
            }
            return Math.exp(-.5 * Math.pow(x - μ, 2) / u) / Math.sqrt(Math.PI * 2 * u);
        }
    </script>
    <script type="text/javascript">
        var dom = document.getElementById("cvs");
        var myChart = echarts.init(dom, null, { renderer: 'svg' });
        var option;
        var user;
        var user;
        var challenge;
        var arena;
        var finish = 0;
        myChart.showLoading();
        $.getJSON('./data/user.json', function (dddd) {
            user = dddd;
            finish++;
            if (finish === 4) myChart.hideLoading();
        });
        $.getJSON('./data/challenge.json', function (dddd) {
            challenge = dddd;
            finish++;
            if (finish === 4) myChart.hideLoading();
        });
        $.getJSON('./data/arena.json', function (dddd) {
            arena = dddd;
            finish++;
            if (finish === 4) myChart.hideLoading();
        });
        $.getJSON('./data/status.json', function (dddd) {
            var date = new Date(dddd.updateTime * 1000);
            var options = { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: 'numeric', second: 'numeric' };
            $('#time').text(date.toLocaleString('zh-cn', options));
            finish++;
            if (finish === 4) myChart.hideLoading();
        });

        function analysis(targetid) {
            if (Object.keys(user[targetid]['friends']).length === 0) {
                var tmpRelationship = {};

                Object.keys(challenge).forEach(function (challenge_category) {
                    Object.keys(challenge[challenge_category]).every(function (challenge_id) {
                        var user_solve_date = 0;
                        challenge[challenge_category][challenge_id].solves.some(function (challenge_solve, index, arry) {
                            if (challenge_solve.id == targetid) {
                                user_solve_date = (new Date(challenge_solve.date)).getTime() / 1000;
                            }
                        });
                        if (user_solve_date === 0) {
                            return true; // every{continue}
                        }
                        challenge[challenge_category][challenge_id].solves.forEach(function (challenge_solve) {
                            var challenge_solve_date = (new Date(challenge_solve.date)).getTime() / 1000;
                            var user_p = normalpdf(challenge_solve_date - user_solve_date, 0, 10000) * 10000;
                            if (!tmpRelationship[challenge_solve['id'].toString()]) {
                                tmpRelationship[challenge_solve['id'].toString()] = 0;
                            }
                            tmpRelationship[challenge_solve['id'].toString()] += user_p;
                        });
                    });
                });

                Object.keys(arena).forEach(function (arena_category) {
                    Object.keys(arena[arena_category]).every(function (arena_id) {
                        var user_solve_date = 0;
                        arena[arena_category][arena_id].solves.some(function (arena_solve, index, arry) {
                            if (arena_solve.id == targetid) {
                                user_solve_date = (new Date(arena_solve.date)).getTime() / 1000;
                            }
                        });
                        if (user_solve_date === 0) {
                            return true; // every{continue}
                        }
                        arena[arena_category][arena_id].solves.forEach(function (arena_solve) {
                            var arena_solve_date = (new Date(arena_solve.date)).getTime() / 1000;
                            var user_p = normalpdf(arena_solve_date - user_solve_date, 0, 10000) * 10000;
                            if (!tmpRelationship[arena_solve['id'].toString()]) {
                                tmpRelationship[arena_solve['id'].toString()] = 0;
                            }
                            tmpRelationship[arena_solve['id'].toString()] += user_p;
                        });
                    });
                });

                if (Object.keys(tmpRelationship).length === 0) {
                    return false;
                }
                tmpRelationship = Object.entries(tmpRelationship).sort(([, a], [, b]) => b - a);
                var tmpSelfDegree = 100 / tmpRelationship.shift()[1];
                tmpRelationship.some(function (friend, index, arry) {
                    if (friend[1] * tmpSelfDegree > 1) {
                        user[targetid]['friends'][friend[0]] = friend[1] * tmpSelfDegree;
                    } else {
                        return true; // some{break}
                    }
                    if (user[targetid]['friends'].length === 100) {
                        return true; // some{break}
                    }
                });
            }
            return true;
        }
        $("#logo").click(function () {
            $('#about').modal('show');
        });
        $("#analysis").click(function () {
            var target = $("#name").val();
            Object.keys(user).some(function (id, index, arry) {
                if (user[id].name === target) {
                    analysis(id);
                    $("#analysisResult tbody").html('');
                    $("#analysisResult tbody").append(
                        '<tr>' +
                        `<th>${id}</th>` +
                        `<td>${user[id].name}</a></td>` +
                        `<td>${user[id].score}</td>` +
                        `<td>${Math.round(100 * 100) / 100} %</td>` +
                        '</tr>'
                    );
                    Object.entries(user[id].friends).sort(([, a], [, b]) => b - a).slice(0, 20).forEach(function (friend) {
                        $("#analysisResult tbody").append(
                            '<tr>' +
                            `<th>${friend[0]}</th>` +
                            `<td>${user[friend[0]].name}</a></td>` +
                            `<td>${user[friend[0]].score}</td>` +
                            `<td>${Math.round(friend[1] * 100) / 100} %</td>` +
                            '</tr>'
                        );
                    });
                    $('#analysisResult').modal('show');
                    return true; // some{break}
                }
            });
        });

        $("#search_all").click(function () {
            myChart.showLoading();
            var target = $("#name").val();
            var graph = {
                nodes: [],
                links: [],
                categories: [
                    { "name": "大学生赛区" },
                    { "name": "河南赛区" },
                    { "name": "广西赛区" },
                    { "name": "中小学生赛区" },
                    { "name": "研究生赛区" }
                ]
            };
            var relations = [];

            function search(id) {
                if (relations.includes(id)) {
                    return;
                }
                relations.push(id);
                // console.log(user[id].name);
                graph.nodes.push({
                    "id": id,
                    "name": user[id].name,
                    "symbolSize": user[id].score / 800,
                    "value": user[id].score,
                    "category": (user[id].name.toUpperCase().startsWith("HN-")) ? 1 : (user[id].name.toUpperCase().startsWith("GX-")) ? 2 : (user[id].name.toUpperCase().startsWith("NYCC-")) ? 3 : (user[id].name.toUpperCase().startsWith("GRD-")) ? 4 : (user[id].name.toUpperCase().startsWith("QT-")) ? 5 : 0
                });

                analysis(id);

                Object.keys(user[id].friends).forEach(function (friend) {
                    if (user[id].friends[friend] > Number($("#minSimilarity").val())) {
                        if (user[friend].score >= Number($("#minScore").val())) {
                            if (analysis(friend) && !!user[friend].friends[id]) {
                                graph.links.push({
                                    "source": id,
                                    "target": friend
                                });
                                search(friend);
                            }
                        }
                    }
                });
            }

            Object.keys(user).some(function (id, index, arry) {
                if (user[id].name === target) {
                    search(id);
                    return true; // some{break}
                }
            });
            option = {
                tooltip: {},
                legend: [{
                    data: graph.categories.map(function (a) {
                        return a.name;
                    })
                }],
                series: [
                    {
                        name: 'ISCCAnalsis',
                        type: 'graph',
                        layout: 'force',
                        data: graph.nodes,
                        links: graph.links,
                        categories: graph.categories,
                        roam: true,
                        label: {
                            show: true,
                            position: 'right',
                            formatter: '{b}'
                        },
                        labelLayout: {
                            hideOverlap: true
                        },
                        scaleLimit: {
                            min: 0.1,
                            max: 20
                        },
                        lineStyle: {
                            color: 'source',
                            curveness: 0.3
                        }
                    }
                ]
            };
            myChart.hideLoading();
            myChart.setOption(option);
        });

        $("#search_single").click(function () {
            myChart.showLoading();
            var target = $("#name").val();
            var graph = {
                nodes: [],
                links: [],
                categories: [
                    { "name": "大学生赛区" },
                    { "name": "河南赛区" },
                    { "name": "广西赛区" },
                    { "name": "中小学生赛区" },
                    { "name": "研究生赛区" },
                    { "name": "其它赛区" }
                ]
            };
            var relations = [];

            function search_norecursion(id) {
                if (relations.includes(id)) {
                    return;
                }
                relations.push(id);
                // console.log(user[id].name);
                graph.nodes.push({
                    "id": id,
                    "name": user[id].name,
                    "symbolSize": user[id].score / 500,
                    "value": user[id].score,
                    "category": (user[id].name.toUpperCase().startsWith("HN-")) ? 1 : (user[id].name.toUpperCase().startsWith("GX-")) ? 2 : (user[id].name.toUpperCase().startsWith("NYCC-")) ? 3 : (user[id].name.toUpperCase().startsWith("GRD-")) ? 4 : (user[id].name.toUpperCase().startsWith("QT-")) ? 5 : 0
                });

                analysis(id);

                Object.keys(user[id].friends).forEach(function (friend) {
                    if (user[id].friends[friend] > Number($("#minSimilarity").val())) {
                        if (user[friend].score >= Number($("#minScore").val())) {
                            if (analysis(friend) && !!user[friend].friends[id]) {
                                graph.links.push({
                                    "source": id,
                                    "target": friend
                                });
                                //search(friend);
                            }
                        }
                    }
                });
            }

            function search(id) {
                if (relations.includes(id)) {
                    return;
                }
                relations.push(id);
                // console.log(user[id].name);
                graph.nodes.push({
                    "id": id,
                    "name": user[id].name,
                    "symbolSize": user[id].score / 500,
                    "value": user[id].score,
                    "category": (user[id].name.toUpperCase().startsWith("HN-")) ? 1 : (user[id].name.toUpperCase().startsWith("GX-")) ? 2 : (user[id].name.toUpperCase().startsWith("NYCC-")) ? 3 : (user[id].name.toUpperCase().startsWith("GRD-")) ? 4 : (user[id].name.toUpperCase().startsWith("QT-")) ? 5 : 0
                });

                analysis(id);

                Object.keys(user[id].friends).forEach(function (friend) {
                    if (user[id].friends[friend] > Number($("#minSimilarity").val())) {
                        if (user[friend].score >= Number($("#minScore").val())) {
                            if (analysis(friend) && !!user[friend].friends[id]) {
                                graph.links.push({
                                    "source": id,
                                    "target": friend
                                });
                                search_norecursion(friend);
                            }
                        }
                    }
                });
            }

            Object.keys(user).some(function (id, index, arry) {
                if (user[id].name === target) {
                    search(id);
                    return true; // some{break}
                }
            });
            option = {
                tooltip: {},
                legend: [{
                    data: graph.categories.map(function (a) {
                        return a.name;
                    })
                }],
                series: [
                    {
                        name: 'ISCCAnalsis',
                        type: 'graph',
                        layout: 'force',
                        data: graph.nodes,
                        links: graph.links,
                        categories: graph.categories,
                        roam: true,
                        label: {
                            show: true,
                            position: 'right',
                            formatter: '{b}'
                        },
                        labelLayout: {
                            hideOverlap: true
                        },
                        scaleLimit: {
                            min: 0.1,
                            max: 20
                        },
                        lineStyle: {
                            color: 'source',
                            curveness: 0.3
                        }
                    }
                ]
            };
            myChart.hideLoading();
            myChart.setOption(option);
        });
    </script>
</body>

</html>